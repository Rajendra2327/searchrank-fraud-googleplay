
  <title>Comment Insert</title> 
<body>
<%@ page contentType="text/html; charset=iso-8859-1" language="java" import="java.sql.*" errorPage="" %>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
</head>
<%@ include file="connect.jsp" %>
 <%@page
	import="java.util.*,java.text.SimpleDateFormat,java.util.Date,java.io.FileInputStream,java.io.FileOutputStream,java.io.PrintStream"%> 
<%
try {
    
String str="comment";
String type=request.getParameter("type");
int one= Integer.parseInt(request.getParameter("id"));
String count3=request.getParameter("k1");
String uname=(String)application.getAttribute("uname");
int rank1=0;

            SimpleDateFormat sdfDate = new SimpleDateFormat("dd/MM/yyyy");
			SimpleDateFormat sdfTime = new SimpleDateFormat("HH:mm:ss");

			Date now = new Date();
			String strDate = sdfDate.format(now);
			String strTime = sdfTime.format(now);
			String dt = strDate + "   " + strTime;
			
			
			
String user=(String)application.getAttribute("uname");
String app=request.getParameter("aname");
String comment=request.getParameter("com");

 String query1="select count,mtype,aname from search where id="+one+" and uname='"+uname+"' and dt='"+strDate+"' and type='"+str+"' group by id "; 
        Statement st1=connection.createStatement();
        ResultSet rs1=st1.executeQuery(query1);
	  if ( rs1.next()==true )//1
	   {
		int k=rs1.getInt(1);
		if(k>=3)
		{
			
			String s8=rs1.getString(2);
			String s9=rs1.getString(3);
			String ip_h = request.getRemoteAddr();  
			String host_h = request.getRemoteHost();  

			Statement st31 = connection.createStatement();
			String query31 ="insert into evidence values('"+uname+"','"+s8+"','"+s9+"',"+one+",'"+ip_h+"','"+host_h+"','"+dt+"','"+str+"')";
			st31.executeUpdate (query31); %>
			
			<b><p2>  <% out.println("You are Blocked for Missusing the Application By Commenting More Then 3 Times and you are Fraud Know..... :-) "); %></p2> </b>
			<p align="right"><a href="U_Main.jsp">Back</a></p>
	<%	}
	if(k<3)
		{

PreparedStatement pst=connection.prepareStatement("insert into comment(appname,c_name,comment,dt) values(?,?,?,?)");
            
			pst.setString(1,app);
            pst.setString(2,user);
            pst.setString(3,comment);
            pst.setString(4,dt);
			
			 int x=pst.executeUpdate();
			
		int id=0;
					if(x>0)
			{
				 String query="select id,rank from application where aname ='"+app+"' "; 
	             Statement st=connection.createStatement();
	    		 ResultSet rs=st.executeQuery(query);
				 if ( rs.next() )
		  				 {
						       id=rs.getInt(1);
							   int rank=rs.getInt(2);

								 rank1=rank+1;
					 Statement st32 = connection.createStatement();
					 String query32 ="update application set rank="+rank1+" where aname='"+app+"' ";
					 st32.executeUpdate (query32);
					 
		Statement st3 = connection.createStatement();
		String query3 ="update search set count=count+1 where id="+one+" and uname='"+uname+"' and dt='"+strDate+"' and type='"+str+"' ";
		st3.executeUpdate (query3);
					 
 					}
                          %> <b> Commented Successfully.						</b>
		                        <p align="center"><a href="U_Comment.jsp?id=<%=id%>&type=<%=type%>&rank=<%=rank1%>" class="style47">Back</a></p>
                          <%
			
								
								
			}
			
		}
	}
	else//1
	{
	
	PreparedStatement pst=connection.prepareStatement("insert into comment(appname,c_name,comment,dt) values(?,?,?,?)");
            
			pst.setString(1,app);
            pst.setString(2,user);
            pst.setString(3,comment);
            pst.setString(4,dt);
			
			 int x=pst.executeUpdate();
			
		int id=0;
					if(x>0)
			{
			    
			    
				 String query="select id,rank,os from application where aname ='"+app+"' "; 
	             Statement st=connection.createStatement();
	    		 ResultSet rs=st.executeQuery(query);
				 if ( rs.next() )
		  				 {
						       id=rs.getInt(1);
							   int rank=rs.getInt(2);
							   String os=rs.getString(3);

								 rank1=rank+1;
					 Statement st32 = connection.createStatement();
					 String query32 ="update application set rank="+rank1+" where aname='"+app+"' ";
					 st32.executeUpdate (query32);
					 

					 int count4=1;		
			Statement st31 = connection.createStatement();
			String query31 ="insert into search values('"+uname+"','"+os+"','"+app+"',"+one+",'"+strDate+"','"+count4+"','"+str+"')";
			st31.executeUpdate (query31);

					 
 					}
                          %> <b> Commented Successfully.						</b>
		                        <p align="center"><a href="U_Comment.jsp?id=<%=id%>&type=<%=type%>&rank=<%=rank1%>" class="style47">Back</a></p>
                          <%
			
								
								
			}
			
	}	
			
		} 
		catch (Exception e) {
		e.printStackTrace();
		}	
			
			

%>
</body>
</html>
